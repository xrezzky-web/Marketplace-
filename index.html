<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Produk</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-900 text-white min-h-screen p-6">

<h1 class="text-2xl font-bold mb-6">Admin Produk</h1>

<!-- ================= FORM ================= -->
<div class="bg-slate-800 p-6 rounded-xl mb-8">
    <div class="grid gap-4">
        <input id="nama" type="text" placeholder="Nama Produk"
            class="p-2 bg-slate-900 border border-slate-700 rounded">

        <input id="harga" type="number" placeholder="Harga"
            class="p-2 bg-slate-900 border border-slate-700 rounded">

        <textarea id="deskripsi" placeholder="Deskripsi"
            class="p-2 bg-slate-900 border border-slate-700 rounded"></textarea>

        <textarea id="note" placeholder="Note Admin"
            class="p-2 bg-slate-900 border border-slate-700 rounded"></textarea>

        <div>
            <p class="mb-2 text-sm text-slate-400">URL Foto (Max 20)</p>
            <div id="image-input-container" class="space-y-2"></div>
        </div>

        <button id="saveBtn"
            class="bg-blue-600 hover:bg-blue-700 p-2 rounded-lg">
            Simpan Produk
        </button>
    </div>
</div>

<!-- ================= LIST PRODUK ================= -->
<div id="productList" class="grid md:grid-cols-3 gap-4"></div>

<!-- ================= DETAIL ================= -->
<div id="detailPage" class="hidden">
    <button onclick="location.reload()" class="mb-4 text-blue-400">← Kembali</button>

    <h2 id="dNama" class="text-2xl font-bold"></h2>
    <p id="dHarga" class="text-green-400 mb-2"></p>
    <p id="dDeskripsi" class="mb-2"></p>
    <p id="dNote" class="text-yellow-400 mb-4"></p>

    <div id="dImages" class="flex gap-3 overflow-x-auto"></div>
</div>

<!-- ================= MODAL ================= -->
<div id="imageModal"
    class="hidden fixed inset-0 bg-black bg-opacity-90 flex flex-col items-center justify-center z-50">

    <button onclick="closeImageModal()"
        class="absolute top-4 right-6 text-3xl">✕</button>

    <button onclick="prevImage()"
        class="absolute left-4 text-4xl">❮</button>

    <img id="modalImage"
        class="max-h-[90vh] object-contain">

    <button onclick="nextImage()"
        class="absolute right-4 text-4xl">❯</button>

    <p id="imageCounter" class="mt-4 text-lg"></p>
</div>

<script type="module">

let products = [];
let currentImages = [];
let currentIndex = 0;

const MAX_IMAGES = 20;

/* ================= VALIDASI IMAGE ================= */

function isValidImageUrl(url) {
    return new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = url + (url.includes("?") ? "&" : "?") + "t=" + Date.now();
    });
}

/* ================= MULTI INPUT ================= */

function createImageInput(value = "") {
    const container = document.getElementById("image-input-container");
    const total = container.querySelectorAll("input").length;
    if (total >= MAX_IMAGES) return;

    const wrapper = document.createElement("div");
    wrapper.className = "flex gap-2 items-center";

    const input = document.createElement("input");
    input.type = "text";
    input.placeholder = "Masukkan URL gambar...";
    input.value = value;
    input.className = "flex-1 p-2 bg-slate-900 border border-slate-700 rounded";

    const preview = document.createElement("img");
    preview.className = "w-12 h-12 object-contain bg-slate-800 rounded hidden";

    input.addEventListener("change", async () => {
        const url = input.value.trim();
        if (!url) return;

        const valid = await isValidImageUrl(url);
        if (!valid) {
            alert("URL bukan gambar valid!");
            input.value = "";
            preview.classList.add("hidden");
            return;
        }

        preview.src = url;
        preview.classList.remove("hidden");

        const inputs = container.querySelectorAll("input");
        if (input === inputs[inputs.length - 1] && inputs.length < MAX_IMAGES) {
            createImageInput();
        }
    });

    wrapper.appendChild(input);
    wrapper.appendChild(preview);
    container.appendChild(wrapper);
}

function getAllImages() {
    const inputs = document.querySelectorAll("#image-input-container input");
    return [...inputs]
        .map(i => i.value.trim())
        .filter(v => v !== "");
}

createImageInput();

/* ================= SIMPAN PRODUK ================= */

document.getElementById("saveBtn").addEventListener("click", () => {

    const nama = document.getElementById("nama").value;
    const harga = document.getElementById("harga").value;
    const deskripsi = document.getElementById("deskripsi").value;
    const note = document.getElementById("note").value;
    const images = getAllImages();

    if (!nama || !harga || images.length === 0) {
        alert("Isi minimal Nama, Harga dan 1 Foto!");
        return;
    }

    products.push({ nama, harga, deskripsi, note, images });
    renderProducts();
});

/* ================= RENDER ================= */

function renderProducts() {
    const list = document.getElementById("productList");
    list.innerHTML = "";

    products.forEach((p, i) => {
        const card = document.createElement("div");
        card.className = "bg-slate-800 p-4 rounded cursor-pointer hover:bg-slate-700";

        card.innerHTML = `
            <img src="${p.images[0]}" class="h-40 w-full object-contain mb-2">
            <h3 class="font-bold">${p.nama}</h3>
            <p class="text-green-400">Rp ${p.harga}</p>
        `;

        card.onclick = () => showDetail(i);
        list.appendChild(card);
    });
}

function showDetail(index) {
    const p = products[index];

    document.querySelector("div.bg-slate-800").classList.add("hidden");
    document.getElementById("productList").classList.add("hidden");
    document.getElementById("detailPage").classList.remove("hidden");

    dNama.innerText = p.nama;
    dHarga.innerText = "Rp " + p.harga;
    dDeskripsi.innerText = p.deskripsi;
    dNote.innerText = p.note;

    const imgContainer = document.getElementById("dImages");
    imgContainer.innerHTML = "";

    p.images.forEach((img, i) => {
        const image = document.createElement("img");
        image.src = img;
        image.className = "h-24 cursor-pointer object-contain bg-slate-800 rounded";
        image.onclick = () => openImageModal(p.images, i);
        imgContainer.appendChild(image);
    });
}

/* ================= MODAL ================= */

window.openImageModal = function(images, index = 0) {
    currentImages = images;
    currentIndex = index;
    updateModalImage();
    imageModal.classList.remove("hidden");
}

window.closeImageModal = function() {
    imageModal.classList.add("hidden");
}

window.nextImage = function() {
    if (currentIndex < currentImages.length - 1) {
        currentIndex++;
        updateModalImage();
    }
}

window.prevImage = function() {
    if (currentIndex > 0) {
        currentIndex--;
        updateModalImage();
    }
}

function updateModalImage() {
    modalImage.src = currentImages[currentIndex];
    imageCounter.innerText =
        (currentIndex + 1) + " / " + currentImages.length;
}

</script>
</body>
    </html>
