<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XREZZKY STORE | Premium Marketplace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: white; overflow-x: hidden; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .hidden { display: none; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 10px; }
    </style>
</head>
<body>
  
  <div id="floatingOrderNotif"
class="hidden fixed bottom-5 right-5 bg-slate-900 border border-blue-500 
p-4 rounded-xl w-80 shadow-2xl z-[999]">

  <h3 class="text-sm font-bold text-blue-400 mb-2">
    Pesanan Diproses
  </h3>

  <img id="notifImage" class="w-full h-32 object-cover rounded mb-2"/>

  <div class="text-xs space-y-1">
    <p id="notifName"></p>
    <p id="notifPrice"></p>
  </div>

  <div class="flex gap-2 mt-3">
    <button onclick="rejectOrder()" 
    class="bg-red-600 w-1/2 py-2 rounded text-xs">
    Tolak
    </button>

    <button onclick="continueToWA()" 
    class="bg-green-600 w-1/2 py-2 rounded text-xs">
    Lanjutkan
    </button>
  </div>
</div>

  <div id="modal-history" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80">
  <div class="bg-slate-900 w-full max-w-lg rounded-2xl border border-slate-700 p-6 relative">
    
    <button onclick="closeModal('modal-history')" 
    class="absolute top-4 right-4 bg-white/10 p-2 rounded-full">
    âœ•
    </button>

    <h2 class="text-xl font-bold mb-4 text-blue-500">
      Riwayat Transaksi
    </h2>

    <div id="historyList" class="space-y-3 max-h-96 overflow-y-auto text-xs">
    </div>

  </div>
</div>

  <div>
  <span id="username-display"></span>
  <p id="order-status" class="text-[10px] text-yellow-400"></p>
</div>

    <div id="profile-menu" class="hidden fixed top-16 left-4 glass p-4 rounded-xl w-64 z-50">
    <p id="profile-join" class="text-xs text-gray-400 mb-3"></p>

    <input type="text" id="new-username"
    placeholder="Ubah Username"
    class="w-full p-2 mb-2 rounded bg-slate-800 border border-slate-700 text-xs">

    <button onclick="updateUsername()"
    class="w-full bg-blue-600 py-2 rounded text-xs mb-2">
    Update Username</button>

    <button onclick="changePassword()"
    class="w-full bg-yellow-600 py-2 rounded text-xs mb-2">
    Ubah Password</button>

    <button onclick="logoutUser()"
    class="w-full bg-gray-600 py-2 rounded text-xs mb-2">
    Logout</button>

    <button onclick="deleteAccount()"
    class="w-full bg-red-600 py-2 rounded text-xs">
    Hapus Akun</button>
    </div>
    
    <div id="loader" class="fixed inset-0 flex items-center justify-center bg-slate-900 z-[999]">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500 border-opacity-50 mb-4"></div>
            <p class="text-blue-400 font-bold tracking-widest">XREZZKY STORE</p>
        </div>
    </div>

    <section id="page-auth" class="hidden min-h-screen flex items-center justify-center p-6">
        <div class="glass p-8 rounded-2xl w-full max-w-md shadow-2xl">
            <h2 id="auth-title" class="text-3xl font-bold mb-2 text-center text-blue-500">Welcome</h2>
            <p id="auth-subtitle" class="text-gray-400 text-center mb-8 text-sm">Silahkan login untuk belanja</p>
            
            <div class="space-y-4">
                <div id="reg-fields" class="hidden space-y-4">
                    <input type="text" id="auth-user" placeholder="Username" class="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                </div>
                <input type="email" id="auth-email" placeholder="Email Address" class="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                <input type="password" id="auth-pass" placeholder="Password" class="w-full p-4 rounded-xl bg-slate-800 border border-slate-700 focus:ring-2 focus:ring-blue-500 outline-none">
                
                <button onclick="handleAuth()" id="btn-auth" class="w-full bg-blue-600 hover:bg-blue-700 py-4 rounded-xl font-bold transition-all transform active:scale-95 shadow-lg shadow-blue-900/20">Login</button>
                
                <div class="flex flex-col gap-3 text-center text-sm mt-6">
                    <span onclick="toggleAuthMode()" id="auth-toggle-text" class="text-blue-400 cursor-pointer hover:underline">Belum punya akun? Daftar sekarang</span>
                    <span onclick="resetPassword()" class="text-gray-500 cursor-pointer hover:text-white">Lupa kata sandi?</span>
                </div>
            </div>
        </div>
    </section>

    <section id="page-marketplace" class="hidden min-h-screen">
        <header class="p-5 glass sticky top-0 z-40 flex justify-between items-center">
            <div class="flex items-center gap-3" onclick="toggleProfileMenu()">
                <img id="user-avatar" src="https://ui-avatars.com/api/?name=User&background=3b82f6&color=fff" class="w-10 h-10 rounded-full border-2 border-blue-500">
                <div>
                    <p class="text-[10px] text-gray-400 uppercase tracking-tighter">Halo, Akun Saya</p>
                    <p id="user-name-display" class="font-bold text-sm truncate w-24">Guest</p>
                </div>
            </div>
            <div class="flex-1 px-4">
                <input type="text" onkeyup="searchProduct(this.value)" placeholder="Cari produk..." class="w-full bg-slate-800 py-2 px-4 rounded-full text-xs border border-slate-700 focus:ring-1 focus:ring-blue-500 outline-none">
            </div>
        </header>

        <main class="p-4 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="product-list">
            </main>

        <div class="fixed bottom-6 left-1/2 -translate-x-1/2 flex items-center gap-8 px-8 py-4 glass rounded-full z-50 shadow-2xl">
            <button onclick="showPage('page-marketplace')" class="text-blue-500"><i class="fa fa-home text-xl"></i></button>
            <button onclick="openHistoryModal()" 
class="bg-slate-800 px-4 py-2 rounded-full text-xs border border-slate-700">
Riwayat
</button>
            <a href="https://xrezzky-web.github.io/xrezzkystore/" class="bg-blue-600 p-4 rounded-full -mt-12 border-8 border-slate-900 shadow-xl"><i class="fa fa-shop text-white"></i></a>
            <button onclick="checkAdminAccess()" class="text-gray-400"><i class="fa fa-grid-2 text-xl"></i><i class="fa fa-user-shield text-xl"></i></button>
        </div>
    </section>

    <section id="page-admin" class="hidden min-h-screen p-6 pb-24">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-2xl font-bold text-blue-500">Admin Panel</h1>
            <button onclick="showPage('page-marketplace')" class="bg-slate-700 px-4 py-2 rounded-lg text-xs">Keluar Admin</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="glass p-6 rounded-2xl">
                <h3 class="font-bold mb-4 border-b border-slate-700 pb-2">Upload Produk Baru</h3>
                <div class="space-y-3">
                    <input type="text" id="p-name" placeholder="Nama Produk" class="w-full p-3 rounded bg-slate-800 border border-slate-700">
                    <input type="number" id="p-price" placeholder="Harga (Angka)" class="w-full p-3 rounded bg-slate-800 border border-slate-700">
                    <input type="text" id="p-img" placeholder="URL Foto Produk" class="w-full p-3 rounded bg-slate-800 border border-slate-700">
                    <textarea id="p-desc" placeholder="Detail Produk" class="w-full p-3 rounded bg-slate-800 border border-slate-700 h-24"></textarea>
                    <input type="number" id="p-stock" placeholder="Jumlah Stok" class="w-full p-3 rounded bg-slate-800 border border-slate-700">
                    <button onclick="saveProduct()" class="w-full bg-green-600 py-3 rounded-xl font-bold mt-2">Posting Produk</button>
                </div>
            </div>

            <div class="glass p-6 rounded-2xl">
                <h3 class="font-bold mb-4 border-b border-slate-700 pb-2">Laporan Penjualan</h3>
                <div id="admin-stats" class="grid grid-cols-2 gap-4">
                    <div class="bg-blue-900/30 p-4 rounded-xl text-center">
                        <p class="text-xs text-blue-300">Total User</p>
                        <p id="stat-users" class="text-2xl font-bold">0</p>
                    </div>
                    <div class="bg-green-900/30 p-4 rounded-xl text-center">
                        <p class="text-xs text-green-300">Total Produk</p>
                        <p id="stat-prods" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="mt-6">
                    <h4 class="text-sm font-bold mb-2">Daftar Pengguna</h4>
                    <div id="admin-user-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                    <h4 class="text-sm font-bold mb-2 mt-4">Pesanan Masuk</h4>
                    <div id="admin-order-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </section>

    <div id="modal-detail" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/90">
        <div class="bg-slate-900 w-full max-w-xl rounded-3xl overflow-hidden relative border border-slate-700">
            <button onclick="closeModal('modal-detail')" class="absolute top-4 right-4 bg-white/10 p-2 rounded-full hover:bg-red-500 transition"><i class="fa fa-times w-5 h-5 flex items-center justify-center"></i></button>
            <img id="m-img" src="" class="w-full h-72 object-cover" onclick="viewImageFull(this.src)">
            <div class="p-6">
                <div class="flex justify-between items-start mb-4">
                    <h2 id="m-title" class="text-2xl font-bold"></h2>
                    <span id="m-stock" class="bg-blue-600/20 text-blue-400 text-[10px] px-3 py-1 rounded-full border border-blue-500/30"></span>
                </div>
                <p id="m-price" class="text-xl font-bold text-blue-500 mb-4"></p>
                <p id="m-desc" class="text-gray-400 text-sm mb-6 leading-relaxed"></p>
                
                <div class="grid grid-cols-2 gap-3">
                    <button id="btn-wa" class="bg-green-600 py-4 rounded-2xl font-bold flex items-center justify-center gap-2 transition hover:bg-green-700"><i class="fab fa-whatsapp text-xl"></i> Beli Sekarang</button>
                    <button id="btn-cart"
class="bg-slate-800 py-4 rounded-2xl font-bold border border-slate-700">
Keranjang</button>
                </div>

                <div class="mt-8 pt-6 border-t border-slate-800">
                    <h4 class="font-bold mb-4 flex items-center gap-2"><i class="fa fa-star text-yellow-500"></i> Ulasan Pembeli</h4>
                    <div id="review-list" class="space-y-4 max-h-40 overflow-y-auto text-xs text-gray-500">
                        <p class="italic text-center">Belum ada ulasan untuk produk ini.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">

// =======================
// ðŸ”¥ IMPORT FIREBASE
// =======================
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getAuth,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { 
  getDatabase,
  ref,
  onValue,
  push,
  update,
  remove,
  get
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";


// =======================
// ðŸ”¥ FIREBASE CONFIG
// =======================
const firebaseConfig = {
  apiKey: "AIzaSyA75bdcfawOi957by8y_4-l4sJCCo6pF88",
  authDomain: "xrezzkystore-marketplace-83bc0.firebaseapp.com",
  databaseURL: "https://xrezzkystore-marketplace-83bc0-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "xrezzkystore-marketplace-83bc0",
  storageBucket: "xrezzkystore-marketplace-83bc0.firebasestorage.app",
  messagingSenderId: "604900856944",
  appId: "1:604900856944:web:c48c973da45214c68a10b5"
};

// =======================
// ðŸ”¥ INIT
// =======================
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

let globalProducts = [];


// =======================
// ðŸ”¥ PAGE SWITCH
// =======================
function showPage(id){
  document.querySelectorAll("section").forEach(sec=>{
    sec.classList.add("hidden");
  });
  document.getElementById(id)?.classList.remove("hidden");
}

function hideLoader(){
  document.getElementById("loader")?.classList.add("hidden");
}


// =======================
// ðŸ”¥ AUTH CHECK
// =======================
onAuthStateChanged(auth, (user)=>{
  if(!user){
    showPage("page-auth");
    hideLoader();
    return;
  }

  showPage("page-marketplace");
  listenProducts();
  listenAdminOrders();
  hideLoader();
});


// =======================
// ðŸ”¥ LOAD PRODUCTS
// =======================
function listenProducts(){
  const productsRef = ref(db,"products");

  onValue(productsRef,(snap)=>{
    const container = document.getElementById("product-list");
    container.innerHTML="";
    globalProducts=[];

    if(!snap.exists()){
      container.innerHTML="<p class='text-center text-gray-500 py-20'>Belum ada produk</p>";
      return;
    }

    snap.forEach(child=>{
      const id = child.key;
      const p = child.val();
      globalProducts.push({...p,id});

      const isOut = p.stock <= 0;
      const img = p.images?.[0] || p.image || "";

      container.innerHTML += `
      <div class="glass rounded-xl overflow-hidden cursor-pointer"
        onclick="viewDetail('${id}')">

        <div class="relative h-40">

          ${auth.currentUser?.email === "xrezzkystore.id@gmail.com" ? `
            <button onclick="event.stopPropagation();editProduct('${id}')"
            class="absolute top-2 left-2 bg-yellow-500 text-xs px-2 py-1 rounded">
            Edit</button>` : ''}

          ${auth.currentUser?.email === "xrezzkystore.id@gmail.com" ? `
            <button onclick="event.stopPropagation();deleteProduct('${id}')"
            class="absolute top-2 right-2 bg-red-600 text-xs px-2 py-1 rounded">
            Hapus</button>` : ''}

          <img src="${img}" class="w-full h-full object-cover">

          ${isOut ? `
          <div class="absolute inset-0 bg-black/70 flex items-center justify-center text-red-500 text-xs font-bold">
          HABIS
          </div>` : ""}
        </div>

        <div class="p-3">
          <h3 class="font-bold text-sm truncate">${p.name}</h3>
          <p class="text-blue-500 font-bold text-sm">
          Rp ${Number(p.price).toLocaleString()}
          </p>
          <p class="text-xs text-gray-400">
          Stok ${p.stock} â€¢ Terjual ${p.sold||0}
          </p>
        </div>
      </div>`;
    });
  });
}


// =======================
// ðŸ”¥ DETAIL PRODUK
// =======================
window.viewDetail = function(id){
  const p = globalProducts.find(x=>x.id===id);
  if(!p) return alert("Produk tidak ditemukan");

  if(p.stock<=0) return alert("Stok habis");

  createOrder(p);
}


// =======================
// ðŸ”¥ CREATE ORDER
// =======================
async function createOrder(product){
  const user = auth.currentUser;
  if(!user) return alert("Login dulu!");

  const orderSnap = await get(ref(db,"orders"));
  let pendingCount=0;

  if(orderSnap.exists()){
    orderSnap.forEach(child=>{
      const o = child.val();
      if(o.userId===user.uid && o.status==="Pending"){
        pendingCount++;
      }
    });
  }

  if(pendingCount>=2){
    alert("Tunggu konfirmasi admin dulu!");
    return;
  }

  await push(ref(db,"orders"),{
    userId:user.uid,
    email:user.email,
    productId:product.id,
    productName:product.name,
    price:product.price,
    createdAt:Date.now(),
    status:"Pending"
  });

  alert("Pesanan dibuat!");
}


// =======================
// ðŸ”¥ ADMIN LIST ORDER
// =======================
function listenAdminOrders(){
  if(!auth.currentUser) return;
  if(auth.currentUser.email!=="xrezzkystore.id@gmail.com") return;

  const list = document.getElementById("admin-order-list");
  const ordersRef = ref(db,"orders");

  onValue(ordersRef,(snap)=>{
    list.innerHTML="";

    if(!snap.exists()){
      list.innerHTML="<p class='text-xs text-gray-500'>Belum ada order</p>";
      return;
    }

    snap.forEach(child=>{
      const o = child.val();

      list.innerHTML+=`
      <div class="bg-slate-800 p-2 rounded text-xs">
        <p class="font-bold text-blue-400">${o.productName}</p>
        <p>${o.email}</p>
        <p class="${o.status==="Pending"?"text-yellow-400":"text-green-400"}">
        ${o.status}
        </p>
        <button onclick="confirmOrder('${child.key}')"
        class="text-green-500 mt-1">Konfirmasi</button>
      </div>`;
    });
  });
}


// =======================
// ðŸ”¥ KONFIRMASI ORDER
// =======================
window.confirmOrder = async function(id){
  await update(ref(db,"orders/"+id),{
    status:"Selesai"
  });
}


// =======================
// ðŸ”¥ DELETE PRODUK
// =======================
window.deleteProduct = async function(id){
  if(!confirm("Hapus produk ini?")) return;
  await remove(ref(db,"products/"+id));
}


// =======================
// ðŸ”¥ EDIT PRODUK (basic)
// =======================
window.editProduct = function(id){
  const p = globalProducts.find(x=>x.id===id);
  if(!p) return;

  const newName = prompt("Nama baru:",p.name);
  if(!newName) return;

  update(ref(db,"products/"+id),{
    name:newName
  });
}


// =======================
// ðŸ”¥ LOGOUT
// =======================
window.logout = function(){
  signOut(auth);
};

</script>

        
</body>
    </html> 
